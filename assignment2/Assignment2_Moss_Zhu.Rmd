---
title: "Assignment 1: Air Transport Since 2013, Winners and Losers "
author: "Christina Moss and Hao Zhu"
date: "`r Sys.Date()`" 
output: 
  html_document:
    toc: true 
    theme: sandstone
    toc_float: true
    toc_depth: 2 
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(ggplot2)
library(knitr)
library(kableExtra)
library(ggtext)
library(readr)
library(tidyr)
library(ggplot2)
```

## Exploring Financial Trends Across Airports with Shared Traits 

In this analysis we will examine financial and budgeting patterns at the Savannah/Hilton Head International Airport and the Charleston International Airport. The cities of Savannah, GA and Charleston, SC are both attractive tourist destinations in the coastal south with relatively similar population sizes. 

### Data Preparation 
```{r}
dat_2021 <- read_csv("Report127_2021.csv",
                     skip = 3,
                     na = "",
                     show_col_types = FALSE)
names(dat_2021) <- trimws(names(dat_2021))

dat_2022 <- read_csv("Report127_2022.csv",
                     skip = 3,
                     na = "",
                     show_col_types = FALSE)
names(dat_2022) <- trimws(names(dat_2022))

dat_2023 <- read_csv("Report127_2023.csv",
                     skip = 3,
                     na = "",
                     show_col_types = FALSE)
names(dat_2023) <- trimws(names(dat_2023))

```

```{r}
charleston_sav_2123 <- rbind(
  dat_2021 %>% 
    filter(`Airport Name` %in% c("CHARLESTON INTL", "SAVANNAH INTERNATIONAL")),
  dat_2022 %>% 
    filter(`Airport Name` %in% c("CHARLESTON INTL", "SAVANNAH INTERNATIONAL")),
  dat_2023 %>% 
    filter(`Airport Name` %in% c("CHARLESTON INTL", "SAVANNAH INTERNATIONAL")))

charleston_sav_2123 <- charleston_sav_2123 %>%
  mutate(
    Year = as.numeric(substr(FYE, nchar(FYE)-3, nchar(FYE)))  # Extract last 4 characters for year
  )

# Verify the result
print(charleston_sav_2123 %>% 
  select(`Airport Name`, FYE, Year) %>%
  arrange(Year, FYE))

```

```{r}
# Select relevant columns for analysis
charleston_sav_analysis <- charleston_sav_2123 %>%
  select(
    # Identifying Information
    `Airport Name`, 
    `Hub Size`,
    State,
    Year,
    
    # Key Revenue Metrics
    `Passenger airline landing fees`,
    `Terminal arrival fees - rents - utilities`,
    `Total Passenger Airline Aeronautical Revenue`,
    `Total Non-Passenger Aeronautical Revenue`,
    `Total Aeronautical Revenue`,
    `Parking and ground transportation`,
    `Terminal-food and beverage`,
    `Terminal-retail stores and duty free`,
    `Rental cars-excludes customer facility charges`,
    `Total Non-Aeronautical Revenue`,
    `Total Operating Revenue`,
    
    # Key Cost Metrics
    `Personnel compensation and benefits`,
    `Communications and utilities`,
    `Supplies and materials`,
    `Contractual services`,
    `Total Operating Expenses`,
    `Operating Income`,
    
    # Operational Metrics
    Enplanements,
    `Landed weights in pounds`,
    `Annual aircraft operations`,
    `Passenger airline cost per enplanement`,
    `Full time equivalent employees at end of year`
  )

# Check the structure
glimpse(charleston_sav_analysis)
```

### Exploring Revenue Breakdown Over Time 
```{r}
# 1. total revenue comparison
ggplot(charleston_sav_analysis, 
       aes(x = Year, y = `Total Operating Revenue`/1000000, 
           fill = `Airport Name`, 
           group = `Airport Name`)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  scale_y_continuous(labels = scales::dollar_format()) +
  labs(title = "Total Operating Revenue by Airport (2021-2023)",
       y = "Revenue (Millions USD)",
       x = "Year") +
  theme(legend.position = "bottom")

# 2. revenue breakdown analysis
revenue_breakdown <- charleston_sav_analysis %>%
  select(`Airport Name`, Year,
         `Total Aeronautical Revenue`,
         `Total Non-Aeronautical Revenue`) %>%
  pivot_longer(cols = c(`Total Aeronautical Revenue`, `Total Non-Aeronautical Revenue`),
               names_to = "Revenue_Type",
               values_to = "Amount")

ggplot(revenue_breakdown, 
       aes(x = Year, y = Amount/1000000, fill = Revenue_Type)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~`Airport Name`) +
  theme_minimal() +
  scale_y_continuous(labels = scales::dollar_format()) +
  labs(title = "Revenue Composition by Airport",
       y = "Revenue (Millions USD)",
       fill = "Revenue Type") +
  theme(legend.position = "bottom")

# 3. Detailed non-aeronautical revenue analysis
non_aero_breakdown <- charleston_sav_analysis %>%
  select(`Airport Name`, Year,
         `Parking and ground transportation`,
         `Terminal-food and beverage`,
         `Terminal-retail stores and duty free`,
         `Rental cars-excludes customer facility charges`) %>%
  pivot_longer(cols = -c(`Airport Name`, Year),
               names_to = "Revenue_Source",
               values_to = "Amount")

# Visualize non-aeronautical revenue breakdown
ggplot(non_aero_breakdown, 
       aes(x = Year, y = Amount/1000000, fill = Revenue_Source)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~`Airport Name`) +
  theme_minimal() +
  scale_y_continuous(labels = scales::dollar_format()) +
  labs(title = "Non-Aeronautical Revenue Sources",
       y = "Revenue (Millions USD)",
       fill = "Revenue Source") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle =0))

# 4. Calculate revenue per enplanement
revenue_metrics <- charleston_sav_analysis %>%
  group_by(`Airport Name`, Year) %>%
  summarize(
    Revenue_Per_Enplanement = `Total Operating Revenue` / Enplanements,
    Aero_Revenue_Per_Enplanement = `Total Aeronautical Revenue` / Enplanements,
    Non_Aero_Revenue_Per_Enplanement = `Total Non-Aeronautical Revenue` / Enplanements
  )

print(revenue_metrics)
```

```{r}

```


### Exploring Cost Breakdown Over Time 

```{r}
# Key Cost Metrics
#`Personnel compensation and benefits`,
#`Communications and utilities`,
#`Supplies and materials`,
#`Contractual services`,
#`Total Operating Expenses`,
#`Operating Income`,

ggplot(charleston_sav_analysis, aes(x=factor(Year), y=`Total Operating Expenses`, group=`Airport Name`)) +
  geom_line(aes(color=`Airport Name`)) +
  geom_point(aes(color=`Airport Name`)) + 
  scale_color_brewer(palette="Paired") +
  scale_x_discrete(breaks=c("2021", "2022", "2023")) +
  scale_y_continuous(labels = scales::label_number(prefix="$", suffix="M", scale=1e-6)) +
  theme_minimal() +
  labs(x="Year",
       y="Total Operating Expenses",
       color="Airport Name")

```

```{r}
# Visualizing expenses vs. income 
ggplot(charleston_sav_analysis, aes(x=factor(Year), y=`Operating Income`, group=`Airport Name`)) +
  geom_line(aes(color=`Airport Name`)) +
  geom_point(aes(color=`Airport Name`)) + 
  scale_color_brewer(palette="Paired") +
  scale_x_discrete(breaks=c("2021", "2022", "2023")) +
  scale_y_continuous(labels = scales::label_number(prefix="$", suffix="M", scale=1e-6)) +
  theme_minimal() +
  labs(x="Year",
       y="Total Operating Income",
       color="Airport Name")
```

```{r}
expenses_long <- charleston_sav_analysis %>%
  pivot_longer(
    cols = c(`Personnel compensation and benefits`,
             `Communications and utilities`,
             `Supplies and materials`,
             `Contractual services`),
    names_to = "Category",
    values_to = "Amount"
  )

ggplot(expenses_long, aes(x=factor(Year), y=Amount, fill=Category)) +
  geom_col(position="dodge") +
  facet_wrap(~`Airport Name`, scales="free_y") +
  scale_y_continuous(labels = scales::label_number(prefix="$", suffix="M", scale=1e-6)) +
  scale_fill_brewer(palette="Set2") +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom"
  ) +
  labs(x="Year",
       y="Amount ($M)",
       title="Expense Categories by Airport Over Time",
       fill="Expense Category")
```

```{r expense_table}
# Calculate specific cost changes over time to see which areas of expense experienced higher investment or cuts
changes_table <- charleston_sav_analysis %>%
  select(`Airport Name`, Year, 
         `Personnel compensation and benefits`,
         `Communications and utilities`,
         `Supplies and materials`,
         `Contractual services`) %>%
  group_by(`Airport Name`) %>%
  summarize(
    # Personnel
    `Personnel % Change 2021-2022` = ((`Personnel compensation and benefits`[Year == 2022] - 
                                      `Personnel compensation and benefits`[Year == 2021]) / 
                                      `Personnel compensation and benefits`[Year == 2021] * 100),
    `Personnel % Change 2022-2023` = ((`Personnel compensation and benefits`[Year == 2023] - 
                                      `Personnel compensation and benefits`[Year == 2022]) / 
                                      `Personnel compensation and benefits`[Year == 2022] * 100),
    `Personnel Total % Change` = ((`Personnel compensation and benefits`[Year == 2023] - 
                                  `Personnel compensation and benefits`[Year == 2021]) / 
                                  `Personnel compensation and benefits`[Year == 2021] * 100),
    
    # Communications
    `Communications % Change 2021-2022` = ((`Communications and utilities`[Year == 2022] - 
                                          `Communications and utilities`[Year == 2021]) / 
                                          `Communications and utilities`[Year == 2021] * 100),
    `Communications % Change 2022-2023` = ((`Communications and utilities`[Year == 2023] - 
                                          `Communications and utilities`[Year == 2022]) / 
                                          `Communications and utilities`[Year == 2022] * 100),
    `Communications Total % Change` = ((`Communications and utilities`[Year == 2023] - 
                                      `Communications and utilities`[Year == 2021]) / 
                                      `Communications and utilities`[Year == 2021] * 100),
    
    # Supplies
    `Supplies % Change 2021-2022` = ((`Supplies and materials`[Year == 2022] - 
                                     `Supplies and materials`[Year == 2021]) / 
                                     `Supplies and materials`[Year == 2021] * 100),
    `Supplies % Change 2022-2023` = ((`Supplies and materials`[Year == 2023] - 
                                     `Supplies and materials`[Year == 2022]) / 
                                     `Supplies and materials`[Year == 2022] * 100),
    `Supplies Total % Change` = ((`Supplies and materials`[Year == 2023] - 
                                 `Supplies and materials`[Year == 2021]) / 
                                 `Supplies and materials`[Year == 2021] * 100),
    
    # Contractual
    `Contractual % Change 2021-2022` = ((`Contractual services`[Year == 2022] - 
                                        `Contractual services`[Year == 2021]) / 
                                        `Contractual services`[Year == 2021] * 100),
    `Contractual % Change 2022-2023` = ((`Contractual services`[Year == 2023] - 
                                        `Contractual services`[Year == 2022]) / 
                                        `Contractual services`[Year == 2022] * 100),
    `Contractual Total % Change` = ((`Contractual services`[Year == 2023] - 
                                    `Contractual services`[Year == 2021]) / 
                                    `Contractual services`[Year == 2021] * 100)
  ) %>%
  # Round all numeric columns to 1 decimal place
  mutate(across(where(is.numeric), ~round(., 1)))


changes_table %>%
  kable(format = "markdown", 
        caption = "Percentage Changes in Expense Categories (2021-2023)")
```

Looks like Savannah made great increases to their contractual services expenses....